#!/bin/bash
# geneabund
# Generated by dx-app-wizard.

main() {

    dx download "$bam" -o ${sampleid}.bam
    dx download "$gtf" -o gencode.gtf.gz

    gunzip gencode.gtf.gz
    cp /datadir/gene_info.human.txt.gz .
    gunzip gene_info.human.txt.gz

    opt=''
    if [[ -n "${glist}" ]]
    then
        dx download "$glist" -o panel.tar.gz
        tar xvfz panel.tar.gz
	opt="-f /data/genelist.txt"
    fi
    docker run -v ${PWD}:/data docker.io/goalconsortium/rna_gene_adundance:1.0.0 -s ${stranded} -g /data/gencode.gtf -p ${sampleid} -b ${sampleid}.bam -i /data/gene_info.human.txt $opt

    tar zvcf  ${sampleid}_stringtie.tar.gz  ${sampleid}_stringtie

    counts=$(dx upload ${sampleid}.cts --brief)
    strcts=$(dx upload ${sampleid}_stringtie.tar.gz --brief)
    fpkm=$(dx upload ${sampleid}.fpkm.txt --brief)

    dx-jobutil-add-output counts "$counts" --class=file
    dx-jobutil-add-output strcts "$strcts" --class=file
    dx-jobutil-add-output fpkm "$fpkm" --class=file
}
